<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

<head>
      <metal:block metal:fill-slot="javascript_head_slot">
        <script type="text/javascript"
          tal:attributes="src string:$portal_url/project.js"></script>
      </metal:block>
</head>

<body onload="javascript:setFromState('hideRow0');">

    <div metal:fill-slot="main"
         tal:define="idIndex python:Iterator(pos=-1);
                     physical_path python: '/'.join(context.getPhysicalPath());
                     iterations python:here.portal_catalog.searchResults(portal_type='Iteration', 
                                                                         path=physical_path);">

        <h1 tal:content="here/title_or_id" class="documentFirstHeading">
            Title or id
        </h1>
	
        <div class="documentDescription" tal:content="here/Description">
            description
        </div>


        <tal:block tal:condition="iterations">
          <h1 class="">Iterations</h1>

          <div class="iterations" 
               tal:repeat="iteration iterations"> 

           <div tal:define="obj iteration/getObject;
                            idx idIndex/next;">

            <table id="sortable"
                   class="listing"
                   border="1"
                   width="65%"
                   cellpadding="0" cellspacing="0"
                   tal:attributes="onload string:javascript:setFromState('hideTable${idx}');">

              <tr>
                <td>        
                  <img src="treeCollapsed.gif"
                       tal:attributes="onclick string:javascript:toggleId('hideTable${idx}');" />

                  <a href=""
                     tal:attributes="href string:${obj/absolute_url}">
                    <img src="#"
                         tal:attributes="src string:${here/portal_url}/${obj/getIcon}"/>
                      <span tal:replace="obj/Title">Title</span>
                  </a>
                </td>
                <td id="iteration-state" colspan="3">status: 
                    <span tal:content="iteration/review_state">Status</span></td> 
              </tr>
              <tr>
                 <td colspan="4" 
                     tal:content="obj/Description">Description </td>
              </tr>
            </table>
              

            <table class="listing" width="65%" border="1"
                   tal:attributes="id string:hideTable${idx};">

              <tr tal:condition="python:obj.contentValues('Story')">
                <th>Title</th>
                <th colspan="2">Progress</th>
                <th>Tasks open</th>
                <th>Tasks completed</th>
              </tr>
 
              <tr tal:define="iteration_path python:'/'.join(obj.getPhysicalPath());
                              stories python:here.portal_catalog.searchResults(portal_type='Story',
                                                                               sort_order='traverse',
                                                                               path=iteration_path);"
                  tal:condition="stories"
                  tal:repeat="story stories">


                <div tal:define="storyObj story/getObject;
                                 progress python:here.getProgress();
                                 getOpenTasks python:here.getOpenTasks(storyObj);
                                 getCompletedTasks python:here.getCompletedTasks(storyObj)">

                  <td> 
                    <a href="" 
                       tal:attributes="href string:${storyObj/absolute_url}">
                       <span tal:content="storyObj/Title">Title</span></a></td>
                  <td tal:content="python:str(progress) + '%' ">&nbsp; </td>
                  <td>
                    <img src="progress.gif" height="12" width="" 
                                                        tal:attributes="width progress"/>&nbsp;</td>
                  <td tal:content="getOpenTasks">tasks open</td>
                  <td tal:content="getCompletedTasks">tasks completed</td>
                       
                </div>                 
              </tr>
            </table> <p>&nbsp;</p>

           </div>
          </div>
        </tal:block>

    </div>
</body>
</html>
