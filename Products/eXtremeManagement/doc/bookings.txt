Test bookings
=============

We want to test some browser views for Bookings.  At first there is only one
Booking (as that is added by the test/utils.py setup method).

    >>> from zope.publisher.browser import TestRequest
    >>> request = TestRequest()
    >>> len(self.catalog(portal_type='Booking'))
    1
    >>> from Products.eXtremeManagement.browser.bookings import BookingsDetailedView
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> len(bookview.bookinglist)
    1
    >>> bookview.bookinglist[0]['booking_hours']
    '3:15'
    >>> bookview.total
    '3:15'

Let's add a Booking as someone else.  That person should by default
only see his own Bookings.

    >>> self.login('employee')
    >>> self.task.invokeFactory('Booking', id='booking-emp', hours=2)
    'booking-emp'
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> len(bookview.bookinglist)
    1
    >>> bookview.bookinglist[0]['booking_hours']
    '2:00'
    >>> bookview.total
    '2:00'
    >>> len(self.catalog(portal_type='Booking'))
    2

Adding another one should update the total actual hours

    >>> self.task.invokeFactory('Booking', id='booking-emp-2', hours=3, minutes=30)
    'booking-emp-2'
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> len(bookview.bookinglist)
    2
    >>> bookview.total
    '5:30'

No bookings have been done in January 2007.

    >>> request = TestRequest(form={'year': 2007, 'month': 1})
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> bookview.bookinglist
    []
    >>> bookview.total
    '0:00'

Let us add one in that month.

    >>> from DateTime import DateTime
    >>> jan1 = DateTime('2007-01-01')
    >>> self.task.invokeFactory('Booking', id='emp-jan1', hours=1, bookingDate=jan1)
    'emp-jan1'

Since I have learned a few things about requests lately, let us check
it in three ways.

We first check it by adding some keyword arguments.

    >>> request = TestRequest()
    >>> bookview = BookingsDetailedView(self.portal, request, year=2007, month=1)
    >>> len(bookview.bookinglist)
    1
    >>> bookview.bookinglist[0]['booking_date'] in ('Jan 01, 2007', '2007-01-01')
    True

Then we check it by adding a dictionary

    >>> request = TestRequest()
    >>> options = dict(year=2007, month=1)
    >>> bookview = BookingsDetailedView(self.portal, request, **options)
    >>> len(bookview.bookinglist)
    1
    >>> bookview.bookinglist[0]['booking_date'] in ('Jan 01, 2007', '2007-01-01')
    True

And then we check it by adjusting the request, to show that the result
is the same.

    >>> request = TestRequest(form={'year': 2007, 'month': 1})
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> len(bookview.bookinglist)
    1
    >>> bookview.bookinglist[0]['booking_date'] in ('Jan 01, 2007', '2007-01-01')
    True

Now, a booking on the first of the month might inadvertently be listed
in the previous month as well.  Let's make sure we do not make that
mistake.

    >>> request = TestRequest(form={'year': 2006, 'month': 12})
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> bookview.bookinglist
    []


Daylight Savings Time can be annoying.  Bookings at Monday March 27
2006 can end up in overviews on Monday *and* Sunday.

    >>> request = TestRequest(form={'year': 2006, 'month': 3})
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> len(bookview.bookinglist)
    0
    >>> monday_after_dst = DateTime('2006-03-27')
    >>> self.task.invokeFactory('Booking', id='emp-mad06', hours=2, bookingDate=monday_after_dst)
    'emp-mad06'
    >>> request = TestRequest(form={'year': 2006, 'month': 3})
    >>> bookview = BookingsDetailedView(self.portal, request)
    >>> len(bookview.bookinglist)
    1

And in practice we noticed that it can apparantely also go wrong when
going from summer to winter time.  So we add a few bookings around
that time too.

In 2006 DST kicked in during the night of Saturday 28 October and
Sunday 29 October, at least in The Netherlands.

    >>> dummy = self.task.invokeFactory('Booking', id='emp-okt1', hours=1, bookingDate=DateTime('2006-10-01'))
    >>> dummy = self.task.invokeFactory('Booking', id='emp-okt28', hours=1, bookingDate=DateTime('2006-10-28'))
    >>> len(BookingsDetailedView(self.portal, TestRequest(form={'year': 2006, 'month': 10})).bookinglist)
    2
    >>> dummy = self.task.invokeFactory('Booking', id='emp-okt29', hours=1, bookingDate=DateTime('2006-10-29'))
    >>> len(BookingsDetailedView(self.portal, TestRequest(form={'year': 2006, 'month': 10})).bookinglist)
    3
    >>> dummy = self.task.invokeFactory('Booking', id='emp-okt30', hours=1, bookingDate=DateTime('2006-10-30'))
    >>> len(BookingsDetailedView(self.portal, TestRequest(form={'year': 2006, 'month': 10})).bookinglist)
    4
    >>> dummy = self.task.invokeFactory('Booking', id='emp-okt31', hours=1, bookingDate=DateTime('2006-10-31'))
    >>> len(BookingsDetailedView(self.portal, TestRequest(form={'year': 2006, 'month': 10})).bookinglist)
    5
    >>> len(BookingsDetailedView(self.portal, TestRequest(form={'year': 2006, 'month': 11})).bookinglist)
    0
    >>> dummy = self.task.invokeFactory('Booking', id='emp-nov1', hours=1, bookingDate=DateTime('2006-11-01'))
    >>> len(BookingsDetailedView(self.portal, TestRequest(form={'year': 2006, 'month': 10})).bookinglist)
    5
    >>> len(BookingsDetailedView(self.portal, TestRequest(form={'year': 2006, 'month': 11})).bookinglist)
    1

This does not show any errors though.  Which reminds us to test the
WeekBookingOverview.  This inherits from the BookingsDetailedView, but
gives a different overview.  Of course it suffers from DST bugs too if
we are not careful.

    >>> from Products.eXtremeManagement.browser.bookings import WeekBookingOverview
    >>> view = WeekBookingOverview(self.portal, TestRequest(form={'year': 2006, 'month': 10}))
    >>> [week['week_total'] for week in view.bookinglist]
    ['1:00', '0:00', '0:00', '0:00', '2:00', '3:00']
